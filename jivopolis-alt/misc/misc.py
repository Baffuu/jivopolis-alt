from datetime import datetime, timezone
from .config import intervals

from typing import Union, Tuple, Optional
from math import ceil

from .constants import OfficialChats
from .. import logger, bot
from ..database import cur

from aiogram.types import InlineKeyboardButton, Message
from aiogram.utils.deep_linking import decode_payload


async def get_link(
    user_id: Optional[int | str] = None,
    encoded_id: Optional[str] = None
) -> str:
    '''
    get link to user profile in the bot

    :param user_id:
    :param encoded_id - encoded user id:

    :returns - bot link of the user:

    :raise ValueError if no arguments will be provided.
    '''
    if not user_id and not encoded_id:
        raise ValueError('there is no user id and no encoded user id.')
    if encoded_id and not user_id:
        user_id = decode_payload(encoded_id)
    me = await bot.get_me()
    return f"https://t.me/{me.username}?start={user_id}"


async def get_embedded_link(
    user_id: str | int,
    nick: str | None = None,
    include_mask: bool = True
) -> str:
    if not nick:
        nick = cur.select("nickname", "userdata").where(user_id=user_id).one()
    return (
        f"<a href='{await get_link(user_id)}'>"
        f"{get_mask(user_id) if include_mask else ''}{nick}</a>"
    )


async def get_embedded_clan_link(
    clan_id: str | int
) -> str:
    clan_type = cur.select("clan_type", "clandata").where(
        clan_id=clan_id).one()
    name = cur.select("clan_name", "clandata").where(clan_id=clan_id).one()
    link = cur.select("link", "clandata").where(clan_id=clan_id).one()
    return (
        f"<a href='{link}'>{name}</a>" if clan_type == 'public' else name
    )


def get_mask(user_id: int | str) -> Union[str, None]:
    '''
    get mask or race of user

    :param user_id:

    :returns - the mask worn by the user or their race:
    '''
    try:
        return (
            cur.execute(
                f"SELECT mask FROM userdata WHERE user_id = {user_id}"
            ).fetchone()[0]
            or cur.execute(
                f"SELECT rase FROM userdata WHERE user_id = {user_id}"
            ).fetchone()[0]
        )
    except TypeError as e:
        logger.exception(e)
        return cur.execute(
            f"SELECT rase FROM userdata WHERE user_id = {user_id}"
        ).one()
    except Exception as e:
        return logger.exception(e)


def current_time() -> float:
    '''returns current Unix time in seconds'''
    return (datetime.now(timezone.utc) -
            datetime.fromtimestamp(0, timezone.utc)).total_seconds()


def isinterval(type: str) -> bool:
    '''returns True if boarding given type of transport
    is available; else False'''
    now = current_time()
    interval = intervals[type]
    return now // 1 % interval[0] <= interval[1]


def remaining(type) -> str:
    '''returns time remaining until boarding given type of transport
    becomes available, in minutes and seconds'''
    now = current_time()
    interval = intervals[type][0]
    seconds = int(interval - now // 1 % interval)
    min, sec = divmod(seconds, 60)
    sec = f"{sec} —Å–µ–∫—É–Ω–¥" if sec != 0 else ""
    return f'{f"{min} –º–∏–Ω—É—Ç " if min != 0 else ""}{sec}'


def get_time_units(time: float) -> Tuple[int, int, int]:
    '''
    :param time: - enter time in seconds

    :returns (hours, minutes, seconds)'''
    hours = int(24-ceil(time / 3600))
    minutes = int(60-ceil(time % 3600 / 60))
    seconds = int(60-ceil(time % 3600 % 60))

    return hours, minutes, seconds


def get_building(place: str) -> InlineKeyboardButton | None:
    '''
    Get InlineKeyboardButton with special building for every location

    :param place:

    :returns `aiogram.types.InlineKeyboardButton`
    '''
    match (place):
        case "–ë–æ—Ç–∞–Ω–∏—á–µ—Å–∫–∞—è":
            button = InlineKeyboardButton(
                text="üå≤ –ñ–∏–≤–æ–ø–æ–ª–∏—Å—Å–∫–∏–π –±–æ—Ç–∞–Ω–∏—á–µ—Å–∫–∏–π —Å–∞–¥",
                callback_data="botan_garden_shop"
            )
        case "–ñ–∏–≤–±–∞–Ω–∫":
            button = InlineKeyboardButton(
                text="üè¶ –ñ–∏–≤–æ–ø–æ–ª–∏—Å—Å–∫–∏–π –±–∞–Ω–∫",
                callback_data="bank")
        case "–£–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç":
            button = InlineKeyboardButton(
                text="üè´ –ñ–∏–≤–æ–ø–æ–ª–∏—Å—Å–∫–∏–π —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç",
                callback_data="university"
            )
        case "–ë–æ—Ä–∏—Å–æ–≤—Å–∫–∞—è –≥–∏–º–Ω–∞–∑–∏—è":
            button = InlineKeyboardButton(
                text="üè´ –ë–æ—Ä–∏—Å–æ–≤—Å–∫–∞—è —Ä–∞–π–æ–Ω–Ω–∞—è –≥–∏–º–Ω–∞–∑–∏—è",
                callback_data="university"
            )
        case "–°—Ä–µ–¥–Ω—è—è —à–∫–æ–ª–∞ –°–º–∏–ª–æ–≤–∏—á–µ–π":
            button = InlineKeyboardButton(
                text="üè´ –°—Ä–µ–¥–Ω—è—è —à–∫–æ–ª–∞ –°–º–∏–ª–æ–≤–∏—á–µ–π",
                callback_data="university"
            )
        case "–ö–æ—Ç–∞–π—Å–∫–∏–π –ú–µ–¥–∏–Ω—Å—Ç–∏—Ç—É—Ç":
            button = InlineKeyboardButton(
                text="üè´ –ö–æ—Ç–∞–π—Å–∫–∏–π –∏–Ω—Å—Ç–∏—Ç—É—Ç –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏—Ö –Ω–∞—É–∫",
                callback_data="university"
            )
        case "–ê–≤—Ç–æ–ø–∞—Ä–∫ –∏–º. –ö–æ—Ç–∞":
            button = InlineKeyboardButton(
                text="üöó –ê–≤—Ç–æ–ø–∞—Ä–∫ –∏–º–µ–Ω–∏ Cat Painted",
                callback_data="car_shop"
            )
        case "–¢–¶ –ú–∏–ì":
            button = InlineKeyboardButton(
                text="üè¨ –¢–æ—Ä–≥–æ–≤—ã–π —Ü–µ–Ω—Ç—Ä –ú–∏–ì",
                callback_data="mall"
            )
        case "–ì–µ–æ—Ä–≥–∏–µ–≤—Å–∫–∞—è":
            button = InlineKeyboardButton(
                text="üç∞ –ö–æ–Ω–¥–∏—Ç–µ—Ä—Å–∫–∞—è \"–°–ª–∞–¥–∫–æ–Å–∂–∫–∞\"",
                callback_data="candy_shop"
            )
        case "–†–∞–π–±–æ–ª—å–Ω–∏—Ü–∞":
            button = InlineKeyboardButton(
                text="üè• –ñ–∏–≤–æ–ø–æ–ª–∏—Å—Å–∫–∞—è —Ä–∞–π–æ–Ω–Ω–∞—è –±–æ–ª—å–Ω–∏—Ü–∞",
                callback_data="hospital_shop"
            )
        case "–°—Ç–∞—Ä–æ–∫–æ—Ç–∞–π—Å–∫–∏–π –§–ê–ü":
            button = InlineKeyboardButton(
                text="üè• –°—Ç–∞—Ä–æ–∫–æ—Ç–∞–π—Å–∫–∏–π —Ñ–µ–ª—å–¥—à–µ—Ä—Å–∫–∏–π –ø—É–Ω–∫—Ç",
                callback_data="hospital_shop"
            )
        case "–°–º–∏–ª–æ–≤–∏—á–∏ (–±–æ–ª—å–Ω–∏—Ü–∞)":
            button = InlineKeyboardButton(
                text="üè• –°–º–∏–ª–æ–≤–∏—á—Å–∫–∞—è –≥–æ—Ä–æ–¥—Å–∫–∞—è –±–æ–ª—å–Ω–∏—Ü–∞",
                callback_data="hospital_shop"
            )
        case "–ë–æ—Ä–∏—Å–æ–≤—Å–∫–∞—è —Ä–∞–π–±–æ–ª—å–Ω–∏—Ü–∞":
            button = InlineKeyboardButton(
                text="üè• –ë–æ—Ä–∏—Å–æ–≤—Å–∫–∞—è —Ä–∞–π–æ–Ω–Ω–∞—è –±–æ–ª—å–Ω–∏—Ü–∞",
                callback_data="hospital_shop"
            )
        case "–ó–æ–æ–ø–∞—Ä–∫":
            button = InlineKeyboardButton(
                text="ü¶ä –ñ–∏–≤–æ–ø–æ–ª–∏—Å—Å–∫–∏–π –∑–æ–æ–ø–∞c—Ä–∫",
                callback_data="zoo_shop"
            )
        case "–ê—ç—Ä–æ–ø–æ—Ä—Ç –ë–æ—Ä–∏—Å–æ–≤":
            button = InlineKeyboardButton(
                text="‚úà –ê—ç—Ä–æ–ø–æ—Ä—Ç –ë–æ—Ä–∏—Å–æ–≤",
                callback_data="airport"
            )
        case "–ù–∞—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –∞—ç—Ä–æ–ø–æ—Ä—Ç":
            button = InlineKeyboardButton(
                text="‚úà –ù–∞—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –∞—ç—Ä–æ–ø–æ—Ä—Ç –ñ–∏–≤–æ–ø–æ–ª–∏—Å",
                callback_data="airport"
            )
        case "–ñ–∏–≤–æ–ø–æ–ª–∏—Å—Å–∫–∏–π –º—É–∑–µ–π":
            button = InlineKeyboardButton(
                text="üèõ –ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–π –º—É–∑–µ–π –ñ–∏–≤–æ–ø–æ–ª–∏—Å–∞",
                callback_data="museum"
            )
        case "–ú–∞–∫–µ–µ–≤–∫–∞":
            button = InlineKeyboardButton(
                text="üçè \"–ù–∞—Ç—É—Ä–∞–ª\". –§—Ä—É–∫—Ç—ã –∏ –æ–≤–æ—â–∏",
                callback_data="fruit_shop"
            )
        case "–†—ã–Ω–æ–∫":
            button = InlineKeyboardButton(
                text="üè£ –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π —Ä—ã–Ω–æ–∫",
                callback_data="central_market_menu"
            )
        case "–ö–æ—Ç–∞–π—Å–∫–∏–π —ç–ª–µ–∫—Ç—Ä–æ–∑–∞–≤–æ–¥":
            button = InlineKeyboardButton(
                text="üè≠ –ö–æ—Ç–∞–π—Å–∫–∏–π –∑–∞–≤–æ–¥ —ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å–∫–∏—Ö –¥–µ—Ç–∞–ª–µ–π",
                callback_data="factory"
            )
        case "–ë–æ—Ä–∏—Å–æ–≤—Å–∫–∏–π –∑–∞–≤–æ–¥":
            button = InlineKeyboardButton(
                text="üè≠ –ó–∞–≤–æ–¥ Transit –ë–æ—Ä–∏—Å–æ–≤",
                callback_data="factory"
            )
        case "–°—Ç–∞–¥–∏–æ–Ω":
            button = InlineKeyboardButton(
                text="üèü –ñ–∏–≤–æ–ø–æ–ª–∏—Å-–ê—Ä–µ–Ω–∞",
                url="t.me/jivopolistour"
            )
        case "–†–æ—â–∞":
            button = InlineKeyboardButton(
                text="üåæ –§–µ—Ä–º–∞",
                callback_data="farm"
            )
        case "–ü–æ—Å—ë–ª–æ–∫ –ì–æ—Ä–Ω—ã–π":
            button = InlineKeyboardButton(
                text="üèî –ê–≥–∑–∞–º–æ–≥–æ—Ä—Å–∫–∏–µ —à–∞—Ö—Ç—ã",
                callback_data="mineshaft"
            )
        case "–ê–≥–∑–∞–º–æ–≥–æ—Ä—Å–∫":
            button = InlineKeyboardButton(
                text="‚õè –ú–∞–≥–∞–∑–∏–Ω —à–∞—Ö—Ç—ë—Ä–∞",
                callback_data="pickaxe_shop"
            )
        case "–ú–æ—Ä—Å–∫–æ–π":
            button = InlineKeyboardButton(
                text="üé£ –†—ã–±–æ–ª–æ–≤–Ω–∞—è —Ç–æ–Ω—è",
                callback_data="fishing"
            )
        case "–£–≥–æ–ª—å":
            button = InlineKeyboardButton(
                text="üè≠ –†–µ—Å—É—Ä—Å–æ–ø–µ—Ä–µ—Ä–∞–±–∞—Ç—ã–≤–∞—é—â–∏–π –∑–∞–≤–æ–¥",
                callback_data="resource_factory"
            )
        case "–î–µ—Ä–µ–≤–Ω—è –û—Å—Ç–∏–Ω—Ç":
            button = InlineKeyboardButton(
                text="üõç –õ–∞–≤–∫–∞ –¥—è–¥–∏ –û—Å–∫–∞—Ä–∞",
                callback_data="oscar_shop"
            )
        case "–ì–µ–Ω–µ—Ä–∞–ª–∞ –®–µ–ª–±–∏":
            button = InlineKeyboardButton(
                text="üì± –ú–∞–≥–∞–∑–∏–Ω —Ç–µ—Ö–Ω–∏–∫–∏ –∏–º–µ–Ω–∏ –®–µ–ª–±–∏",
                callback_data="phone_shop"
            )
        case "–ì–ª–∏–Ω—è–Ω–∫–∞":
            button = InlineKeyboardButton(
                text="üè¨ –¶–µ–Ω—Ç—Ä —Å–±–æ—Ä–∞ –ø–æ–ª–µ–∑–Ω—ã—Ö –∏—Å–∫–æ–ø–∞–µ–º—ã—Ö",
                callback_data="resource_market"
            )
        case '–ü–ª–æ—â–∞–¥—å –ú–∞–∫—Å–∏–º–∞':
            button = InlineKeyboardButton(
                text='üè¨ –¢–¶ –ú–∞–∫—Å–∏–º–¥–æ–º',
                callback_data='maximdom_floor_1'
            )
        case "–ü–ª–æ—â–∞–¥—å –ê–¥–º–∏–Ω–æ–≤":
            button = InlineKeyboardButton(
                text="üìä –ë–∏—Ä–∂–∞",
                callback_data="exchange_center"
            )
        case "–ñ–æ–¥–∏–Ω–æ":
            button = InlineKeyboardButton(
                text="üçï OwlPizza",
                callback_data="owlpizza"
            )
        case "–ê–¥–º–∏–Ω—Å–∫–∞—è —É–ª–∏—Ü–∞":
            button = InlineKeyboardButton(
                text="‚òïÔ∏è –ü–æ–¥–∞—Ç—å –∞–¥–º–∏–Ω–∞–º –Ω–∞ —á–∞–π",
                callback_data="donate"
            )
        case _:
            return None
    return button


async def log_to_telegram(message: str, tag: str) -> Message:
    return await bot.send_message(
        OfficialChats.LOGCHAT,
        f"<i>{message} | {tag}</i>"
    )


tglog = log_to_telegram  # alias for telegram logger
